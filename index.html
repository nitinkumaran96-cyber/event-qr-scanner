<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Event QR Scanner</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #121212;
        color: white;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    #signin-button {
        margin-top: 20px;
    }
    #scanner-container {
        position: relative;
        width: 90vw;
        max-width: 400px;
        aspect-ratio: 1 / 1;
        margin-top: 20px;
        border: 2px solid #00ff99;
        display: none; /* hidden until sign-in */
    }
    #reader {
        width: 100%;
        height: 100%;
    }
    #result-banner {
        margin-top: 20px;
        padding: 10px;
        font-size: 18px;
        text-align: center;
        border-radius: 8px;
        display: none;
    }
    .green { background: #28a745; }
    .yellow { background: #ffc107; color: black; }
    .red { background: #dc3545; }
</style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<h1>Event QR Scanner</h1>
<div id="signin-button"></div>

<div id="scanner-container">
    <div id="reader"></div>
</div>

<div id="result-banner"></div>

<audio id="beep-sound" src="BeepSound.mp3"></audio>
<audio id="done-sound" src="DoneSound.mp3"></audio>
<audio id="error-sound" src="ErrorSound.mp3"></audio>

<script>
const CLIENT_ID = "61888524341-ntav1kdh5uad0rdcarpb5n7pg7brln92.apps.googleusercontent.com";
const API_KEY = "AIzaSyCX7SKx2y106S5j4yfnORakKmpAIhEoCtI";
const SPREADSHEET_ID = "1PHBW9iRt6I26-YAKi-_AwkCZo-NlktJCQalJHfw-s0M";
const RANGE = "CleanedData!A:Z";
const SERIAL_COL_HEADER = "Serial Number";

let scannedRecently = false;
let sheetData = [];
let signedIn = false;

// Initialize Google API client
function initClient() {
    gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
        scope: "https://www.googleapis.com/auth/spreadsheets"
    }).then(() => {
        document.getElementById("signin-button").innerHTML = '<button id="authBtn">Sign in with Google</button>';
        document.getElementById("authBtn").addEventListener("click", handleAuthClick);
    });
}

// Handle sign-in
function handleAuthClick() {
    gapi.auth2.getAuthInstance().signIn().then(() => {
        signedIn = true;
        document.getElementById("signin-button").style.display = "none";
        loadSheetData();
    }).catch(err => console.error("Sign-in failed:", err));
}

// Load sheet data
function loadSheetData() {
    gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE
    }).then(response => {
        const rows = response.result.values;
        if (rows.length) {
            const headers = rows[0];
            const serialIndex = headers.indexOf(SERIAL_COL_HEADER);
            const checkedInIndex = headers.indexOf("Checked In");
            sheetData = rows.slice(1).map(row => ({
                serial: row[serialIndex],
                checkedIn: row[checkedInIndex]
            }));
            startScanner();
        }
    }).catch(err => console.error("Failed to load sheet data:", err));
}

// Start the QR scanner
function startScanner() {
    const container = document.getElementById("scanner-container");
    container.style.display = "block";
    setTimeout(() => { // slight delay ensures DOM is ready
        const html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            qrCodeMessage => {
                if (!scannedRecently) {
                    scannedRecently = true;
                    handleScan(qrCodeMessage);
                    setTimeout(() => scannedRecently = false, 2000);
                }
            },
            errorMessage => {
                // optional: console.warn(errorMessage);
            }
        );
    }, 100);
}

// Handle scan result
function handleScan(data) {
    navigator.vibrate?.(200);
    document.getElementById("beep-sound").play();
    const match = sheetData.find(row => row.serial === data);
    const banner = document.getElementById("result-banner");
    banner.style.display = "block";
    if (match) {
        if (match.checkedIn && match.checkedIn.toLowerCase() === "yes") {
            banner.textContent = "Already Checked In";
            banner.className = "yellow";
            document.getElementById("done-sound").play();
        } else {
            banner.textContent = "Checked In Successfully!";
            banner.className = "green";
            document.getElementById("done-sound").play();
            updateCheckIn(match.serial);
        }
    } else {
        banner.textContent = "Not Registered";
        banner.className = "red";
        document.getElementById("error-sound").play();
    }
}

// Update Google Sheet
function updateCheckIn(serial) {
    gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE
    }).then(response => {
        const rows = response.result.values;
        const headers = rows[0];
        const serialIndex = headers.indexOf(SERIAL_COL_HEADER);
        const checkedInIndex = headers.indexOf("Checked In");
        const rowIndex = rows.findIndex(row => row[serialIndex] === serial) + 1;
        if (rowIndex > 0) {
            gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: `CleanedData!${String.fromCharCode(65 + checkedInIndex)}${rowIndex + 1}`,
                valueInputOption: "RAW",
                resource: { values: [["Yes"]] }
            }).then(() => console.log("Check-in updated"));
        }
    }).catch(err => console.error("Failed to update check-in:", err));
}

// Load client
gapi.load("client:auth2", initClient);
</script>

</body>
</html>
