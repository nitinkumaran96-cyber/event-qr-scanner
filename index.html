<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Code Scanner</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #222;
      color: #fff;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    #reader {
      width: 100%;
      flex: 1;
    }
    #resultBox {
      text-align: center;
      font-size: 1.3em;
      padding: 15px;
      margin: 0;
      display: none;
    }
    .green { background-color: #28a745; }
    .yellow { background-color: #ffc107; color: #222; }
    .red { background-color: #dc3545; }
    #signInBtn {
      width: 100%;
      padding: 15px;
      font-size: 1.2em;
      border: none;
      background-color: #007bff;
      color: #fff;
    }
  </style>
</head>
<body>
  <div id="reader"></div>
  <div id="resultBox"></div>
  <button id="signInBtn">Sign in to Google</button>

  <script>
    // ======= CONFIG =======
    const CLIENT_ID = "761888524341-ntav1kdh5uad0rdcarpb5n7pg7brln92.apps.googleusercontent.com"; // Replace with your OAuth Client ID
    const SPREADSHEET_ID = "1PHBW9iRt6I26-YAKi-_AwkCZo-NlktJCQalJHfw-s0M"; // Replace with your Google Sheet ID
    const SHEET_NAME = "CleanedData"; // Sheet name

    // ======= SOUNDS =======
    const beepSound = new Audio("https://github.com/nitinkumaran96-cyber/scanner-sounds/raw/refs/heads/main/BeepSound.mp3");
    const errorSound = new Audio("https://github.com/nitinkumaran96-cyber/scanner-sounds/raw/refs/heads/main/ErrorSound.mp3");
    const doneSound = new Audio("https://github.com/nitinkumaran96-cyber/scanner-sounds/raw/refs/heads/main/DoneSound.mp3");

    const resultBox = document.getElementById("resultBox");

    function showResult(status, message) {
      if (status === "success") {
        resultBox.className = "green";
        doneSound.play();
      } else if (status === "already_checked_in") {
        resultBox.className = "yellow";
        doneSound.play();
      } else if (status === "not_registered") {
        resultBox.className = "red";
        errorSound.play();
      }
      resultBox.innerHTML = message;
      resultBox.style.display = "block";
      setTimeout(() => resultBox.style.display = "none", 2500);
    }

    // ======= GOOGLE API =======
    let tokenClient;

    function gapiLoaded() {
      gapi.load('client', async () => {
        await gapi.client.init({
          discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
        });
      });
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: "https://www.googleapis.com/auth/spreadsheets",
        callback: () => console.log("Signed in")
      });
    }

    document.getElementById("signInBtn").onclick = () => {
      tokenClient.requestAccessToken();
      document.getElementById("signInBtn").style.display = "none";
    };

    async function markAttendance(serial) {
      try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: SHEET_NAME + "!A:B"
        });
        const rows = response.result.values || [];
        let found = false;
        for (let i = 1; i < rows.length; i++) {
          if (rows[i][0]?.trim() === serial.trim()) {
            found = true;
            if (rows[i][1] === "Checked In") {
              showResult("already_checked_in", rows[i][0] + " has already checked in.");
            } else {
              await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: `${SHEET_NAME}!B${i+1}`,
                valueInputOption: "RAW",
                resource: { values: [["Checked In"]] }
              });
              showResult("success", rows[i][0] + " successfully checked in.");
            }
            break;
          }
        }
        if (!found) showResult("not_registered", "Serial not registered: " + serial);
      } catch (err) {
        console.error(err);
        showResult("not_registered", "Error: " + err.message);
      }
    }

    // ======= QR SCANNER =======
    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: 250, height: 250 } },
      (decodedText) => { beepSound.play(); markAttendance(decodedText); },
      (err) => console.warn(err)
    );

    // ======= LOAD GOOGLE LIBS =======
    const gapiScript = document.createElement("script");
    gapiScript.src = "https://apis.google.com/js/api.js";
    gapiScript.onload = gapiLoaded;
    document.body.appendChild(gapiScript);

    const gisScript = document.createElement("script");
    gisScript.src = "https://accounts.google.com/gsi/client";
    gisScript.onload = gisLoaded;
    document.body.appendChild(gisScript);
  </script>
</body>
</html>
